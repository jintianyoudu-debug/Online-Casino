<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ブラックジャック｜マナ党~オンラインカジノ編~</title>
<style>

:root{
  --bg0:#04120b;
  --bg1:#061d12;
  --felt:#0b3a24;
  --felt2:#0a2f1d;
  --panel:rgba(9,24,16,.72);
  --text:#f4f7ff;
  --muted:#b7c3d9;
  --gold:#d6b25e;
  --gold2:#ffdf8a;
  --danger:#ff5a6b;
  --ok:#57ff9a;
  --shadow: 0 18px 60px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font-family: system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;
  background:
    radial-gradient(900px 520px at 30% 0%, rgba(214,178,94,.16), transparent 60%),
    radial-gradient(1100px 720px at 80% 10%, rgba(0,0,0,.45), transparent 62%),
    radial-gradient(900px 700px at 50% 120%, rgba(0,0,0,.55), transparent 62%),
    linear-gradient(180deg, var(--bg1), var(--bg0));
}
a{color:inherit}
.container{max-width:1100px;margin:0 auto;padding:16px}
.topbar{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:10px 12px;border-radius:16px;
  background: rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.08);
  box-shadow: var(--shadow);
}
.brand{display:flex;flex-direction:column;gap:2px}
.brand h1{margin:0;font-size:18px;letter-spacing:.6px}
.brand .sub{font-size:12px;color:rgba(244,247,255,.72)}
.nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.btn{
  appearance:none;border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 12px;border-radius:14px;
  font-weight:800;font-size:13px;
  cursor:pointer;
  box-shadow: 0 14px 34px rgba(0,0,0,.30);
  transition: transform .06s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
  text-decoration:none; display:inline-flex; align-items:center; justify-content:center; gap:8px;
}
.btn:hover{background: rgba(255,255,255,.10)}
.btn:active{transform: translateY(1px)}
.btn.primary{
  border-color: rgba(214,178,94,.40);
  background: rgba(214,178,94,.14);
}
.btn.danger{
  border-color: rgba(255,90,107,.35);
  background: rgba(255,90,107,.12);
}
.pill{
  font-size:12px;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);
  color:rgba(244,247,255,.78);
  white-space:nowrap;
}
.gold-frame{
  border-radius:18px;
  border:2px solid rgba(214,178,94,.72);
  box-shadow:
    0 0 10px rgba(214,178,94,.45),
    0 0 24px rgba(214,178,94,.25),
    inset 0 0 18px rgba(255,215,128,.18);
  position:relative;
}
.gold-frame::after{
  content:"";
  position:absolute; inset:-2px;
  border-radius:20px;
  background: linear-gradient(120deg, transparent 28%, rgba(255,223,138,.40), transparent 70%);
  background-size: 220% 100%;
  animation: goldShine 3.2s linear infinite;
  pointer-events:none;
  opacity:.8;
}
@keyframes goldShine{
  from{background-position:-200% 0}
  to{background-position:200% 0}
}
.cardpanel{
  background: var(--panel);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow: var(--shadow);
}

.tableWrap{margin-top:14px; padding:14px;}
.table{position:relative; overflow:hidden; padding:16px; border-radius:22px;
  background:
    radial-gradient(900px 480px at 50% 20%, rgba(255,255,255,.06), transparent 62%),
    radial-gradient(700px 520px at 15% 70%, rgba(0,0,0,.28), transparent 62%),
    radial-gradient(700px 520px at 85% 70%, rgba(0,0,0,.28), transparent 62%),
    linear-gradient(180deg, var(--felt), var(--felt2));
  border:1px solid rgba(255,255,255,.10);
  box-shadow: var(--shadow);
}
.table::before{
  content:"";
  position:absolute; inset:-40px;
  background:
    radial-gradient(circle at 15% 20%, rgba(214,178,94,.10), transparent 40%),
    radial-gradient(circle at 85% 30%, rgba(214,178,94,.08), transparent 42%),
    radial-gradient(circle at 50% 85%, rgba(214,178,94,.07), transparent 45%);
  pointer-events:none;
}
.zone{position:relative; z-index:1; display:grid; gap:12px;}
.hand{padding:14px; border-radius:18px; background: rgba(0,0,0,.20);
  border:1px solid rgba(255,255,255,.10);
}
.handHead{display:flex; align-items:flex-end; justify-content:space-between; gap:10px; margin-bottom:10px}
.handHead h2{margin:0;font-size:14px; letter-spacing:.7px}
.totalBig{font-size:12px; color:rgba(244,247,255,.72)}
.totalBig b{font-size:18px; color:var(--gold2)}
.cards{display:flex; flex-wrap:wrap; gap:12px; padding:6px 4px; min-height:150px; align-items:center}
.cards .cardImg{margin-right:-18px}
.cards .cardImg:last-child{margin-right:0}
.cardImg{
  width:clamp(96px, 18vw, 124px);
  height:auto;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.25);
  box-shadow:
    0 22px 52px rgba(0,0,0,.48),
    0 2px 0 rgba(255,255,255,.10) inset;
  transform-origin: 50% 90%;
  animation: popIn .20s ease-out;
}

.cardImg.deal{
  animation: dealIn .18s ease-out both;
}
@keyframes dealIn{
  from{ transform: translateY(-10px) scale(.98); opacity:0; }
  to{ transform: translateY(0) scale(1); opacity:1; }
}

/* テーブル下の“空白”対策：チップレール */
.rail{
  margin-top:14px;
  padding:12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.railLeft{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.chip{
  width:34px; height:34px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 50%),
    radial-gradient(circle at 60% 70%, rgba(0,0,0,.35), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.08));
  box-shadow: 0 10px 26px rgba(0,0,0,.35);
  position:relative;
}
.chip::after{
  content:"";
  position:absolute; inset:6px;
  border-radius:999px;
  border:2px dashed rgba(255,255,255,.22);
}
.railText{
  color:rgba(255,255,255,.75);
  font-size:12px;
  line-height:1.5;
  text-align:right;
}
@keyframes popIn{from{transform: translateY(10px) scale(.98); opacity:0} to{transform: translateY(0) scale(1); opacity:1}}
@media(min-width:420px){.cardImg{width:96px}}
.controls{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:12px}
@media(max-width:520px){.controls{grid-template-columns: repeat(2, 1fr);}}
.statusRow{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
.statusBox{flex:1; min-width:240px; padding:12px; border-radius:16px;
  background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.10);
}
#resultText{font-weight:1000; letter-spacing:1px; font-size:16px}
#hint{margin-top:4px; color:rgba(244,247,255,.72); font-size:12px; line-height:1.6}
.win{color:var(--ok)} .lose{color:var(--danger)} .draw{color:var(--gold2)}
.rewardOverlay{display:none; position:fixed; inset:0; background: rgba(0,0,0,.62);
  backdrop-filter: blur(6px); z-index:9999; padding:18px;
  align-items:center; justify-content:center;
}
.rewardCard{max-width:680px; width:100%; padding:14px; text-align:center}
#winText{margin:6px 0 10px; font-size:20px; font-weight:1000; letter-spacing:1px}
#winRewardImg{max-width:min(92vw, 620px); max-height:62vh; border-radius:16px;
  border:1px solid rgba(255,255,255,.16);
  box-shadow: 0 22px 70px rgba(0,0,0,.45);
}
.kbar{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

/* 追加：カジノ感（微振れ・フラッシュ） */
.table.shake{animation: tableShake .16s linear;}
@keyframes tableShake{
  0%{transform:translate(0,0)}
  20%{transform:translate(2px,-1px)}
  40%{transform:translate(-2px,1px)}
  60%{transform:translate(2px,1px)}
  80%{transform:translate(-1px,-1px)}
  100%{transform:translate(0,0)}
}
.table.flash{
  box-shadow:
    0 0 14px rgba(214,178,94,.50),
    0 0 28px rgba(214,178,94,.25),
    0 18px 60px rgba(0,0,0,.45);
}

</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <h1>マナ党~オンラインカジノ編~</h1>
      <div class="sub">ブラックジャック</div>
    </div>
    <div class="nav">
      <a class="btn" href="index.html">ロビー</a>
      <a class="btn" href="profile.html">プロフィール</a>
      <button class="btn" id="soundBtn" type="button">SE：ON</button>
      <span class="pill" id="shoePill">山札：--</span>
    </div>
  </div>

  <section class="tableWrap">
    <div class="table gold-frame">
      <div class="zone">
        <div class="hand">
          <div class="handHead">
            <h2>ディーラー</h2>
            <div class="totalBig">合計：<b id="dealerTotal">?</b></div>
          </div>
          <div id="dealerCards" class="cards"></div>
        </div>

        <div class="hand">
          <div class="handHead">
            <h2>あなた</h2>
            <div class="totalBig">合計：<b id="playerTotal">0</b></div>
          </div>
          <div id="playerCards" class="cards"></div>

          <div class="controls">
            <button class="btn primary" id="dealBtn" type="button">DEAL</button>
            <button class="btn primary" id="hitBtn" type="button" disabled>HIT</button>
            <button class="btn" id="standBtn" type="button" disabled>STAND</button>
            <button class="btn danger" id="restartBtn" type="button">RESET</button>
          </div>

          <div class="statusRow">
            <div class="statusBox">
              <div id="resultText">WELCOME</div>
              <div id="hint">まずは <b>DEAL</b> を押して開始してください。</div>
            </div>
            <div class="kbar">
              <span class="pill">勝利：ご褒美</span>
              <span class="pill">21勝利：特別</span>
            </div>
          </div>
        </div>
      </div>
      <div class="rail">
        <div class="railLeft" aria-hidden="true">
          <div class="chip"></div><div class="chip"></div><div class="chip"></div>
          <div class="chip"></div><div class="chip"></div>
        </div>
        <div class="railText">
          <div>勝利でご褒美が出ます</div>
          <div style="opacity:.85">21ぴったりは特別</div>
        </div>
      </div>

    </div>
  </section>
</div>

<div class="rewardOverlay" id="rewardOverlay">
  <div class="cardpanel gold-frame rewardCard">
    <div id="winText">WIN!</div>
    <img id="winRewardImg" src="" alt="reward"/>
    <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button class="btn primary" id="nextHandBtn" type="button">次の勝負へ</button>
      <button class="btn" id="closeRewardBtn" type="button">閉じる</button>
    </div>
  </div>
</div>

<script>
const CARD_BACK = "assets/cards/BACK.png";
const rewardImages = [
  "assets/win/1.jpg","assets/win/2.jpg","assets/win/3.jpg",
  "assets/win/4.jpg","assets/win/5.jpg","assets/win/6.jpg",
  "assets/win/7.jpg","assets/win/8.jpg","assets/win/9.jpg"
];
const specialRewardImages = [
  "assets/special/1.jpg",
  "assets/special/2.jpg"
];

const SFX_KEY="mana_party_sfx";
const soundBtn=document.getElementById("soundBtn");
function isSfxOn(){
  const v=localStorage.getItem(SFX_KEY);
  return (v===null) ? true : (v==="1");
}
function refreshSfxBtn(){
  soundBtn.textContent = "SE：" + (isSfxOn() ? "ON" : "OFF");
}
refreshSfxBtn();

const sfx = {
  deal: new Audio("assets/sfx/deal.ogg"),
  hit: new Audio("assets/sfx/hit.ogg"),
  stand: new Audio("assets/sfx/stand.ogg"),
  win: new Audio("assets/sfx/win.ogg"),
  lose: new Audio("assets/sfx/lose.ogg"),
  blackjack: new Audio("assets/sfx/blackjack.ogg"),
  shuffle: new Audio("assets/sfx/shuffle.ogg")
};
for (const a of Object.values(sfx)) {
  a.preload="auto";
  a.volume=0.75;
}
function playSfx(name){
  if (!isSfxOn()) return;
  const a=sfx[name];
  if(!a) return;
  try{ a.currentTime=0; a.play(); }catch(e){}
}

function impact(kind="light"){
  const table=document.querySelector(".table");
  if(!table) return;

  // ふわっと光る
  table.classList.add("flash");
  setTimeout(()=>table.classList.remove("flash"), 240);

  // ちいさく揺らす
  table.classList.remove("shake");
  // reflow
  void table.offsetWidth;
  table.classList.add("shake");
  setTimeout(()=>table.classList.remove("shake"), 200);

  // 端末が対応していれば、軽くバイブ（強すぎない）
  try{
    if (navigator.vibrate) navigator.vibrate(kind==="heavy" ? 18 : 10);
  }catch(e){}
}

soundBtn.addEventListener("click", ()=>{
  const on=isSfxOn();
  localStorage.setItem(SFX_KEY, on ? "0":"1");
  refreshSfxBtn();
  playSfx("hit");
  impact("light");
});

const SUITS=["S","H","D","C"];
const RANKS=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

let deck=[];
let playerHand=[];
let dealerHand=[];
let revealHole=false;
let gameOver=true;
let lastReward=null;

const elDealerCards=document.getElementById("dealerCards");
const elPlayerCards=document.getElementById("playerCards");
const elDealerTotal=document.getElementById("dealerTotal");
const elPlayerTotal=document.getElementById("playerTotal");
const elResultText=document.getElementById("resultText");
const elHint=document.getElementById("hint");
const elShoePill=document.getElementById("shoePill");

const dealBtn=document.getElementById("dealBtn");
const hitBtn=document.getElementById("hitBtn");
const standBtn=document.getElementById("standBtn");
const restartBtn=document.getElementById("restartBtn");

const rewardOverlay=document.getElementById("rewardOverlay");
const winText=document.getElementById("winText");
const winRewardImg=document.getElementById("winRewardImg");
const closeRewardBtn=document.getElementById("closeRewardBtn");
const nextHandBtn=document.getElementById("nextHandBtn");

function newDeck(){
  const d=[];
  for(const s of SUITS) for(const r of RANKS) d.push({rank:r,suit:s});
  return shuffle(d);
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function draw(){
  if(deck.length===0){ deck=newDeck(); playSfx("shuffle"); }
  return deck.pop();
}
function cardImgPath(card){
  return `assets/cards/${card.rank}${card.suit}.png`;
}
function cardValue(rank){
  if(rank==="A") return 11;
  if(rank==="K"||rank==="Q"||rank==="J") return 10;
  return Number(rank);
}
function handTotal(hand){
  let total=0, aces=0;
  for(const c of hand){
    total += cardValue(c.rank);
    if(c.rank==="A") aces++;
  }
  while(total>21 && aces>0){ total -= 10; aces--; }
  return total;
}
function dealerShouldHit(total){
  if(total<=14) return Math.random()<0.80;
  if(total<=17) return Math.random()<0.50;
  if(total<=19) return Math.random()<0.25;
  return false;
}
function setStatus(text, mode=null){
  elResultText.classList.remove("win","lose","draw");
  if(mode) elResultText.classList.add(mode);
  elResultText.textContent=text;
}
function setHint(html){ elHint.innerHTML=html; }
function setButtons(){
  hitBtn.disabled = gameOver;
  standBtn.disabled = gameOver;
  dealBtn.disabled = !gameOver;
}
function renderHands(){
  elDealerCards.innerHTML="";
  dealerHand.forEach((c,i)=>{
    const img=document.createElement("img");
    img.className="cardImg deal";
    img.style.animationDelay = `${i*70}ms`;
    img.alt="card";
    img.src = (i===1 && !revealHole) ? CARD_BACK : cardImgPath(c);
    elDealerCards.appendChild(img);
  });
  elPlayerCards.innerHTML="";
  playerHand.forEach((c)=>{
    const img=document.createElement("img");
    img.className="cardImg deal";
    const i = elPlayerCards.children.length;
    img.style.animationDelay = `${i*70}ms`;
    img.alt="card";
    img.src = cardImgPath(c);
    elPlayerCards.appendChild(img);
  });
  elPlayerTotal.textContent = String(handTotal(playerHand));
  elDealerTotal.textContent = revealHole ? String(handTotal(dealerHand)) : "?";
  elShoePill.textContent = `山札：${deck.length}枚`;
}
function resetHand(){
  playerHand=[]; dealerHand=[]; revealHole=false;
}
function openReward(isSpecial){
  const list = (isSpecial && specialRewardImages.length) ? specialRewardImages : rewardImages;
  if(!list.length) return;
  let pick = list[Math.floor(Math.random()*list.length)];
  if(list.length>1){
    let guard=0;
    while(pick===lastReward && guard<10){ pick=list[Math.floor(Math.random()*list.length)]; guard++; }
  }
  lastReward=pick;
  winText.textContent = isSpecial ? "BLACKJACK!!" : "WIN!";
  winRewardImg.src = pick;
  rewardOverlay.style.display="flex";
}
function closeReward(){ rewardOverlay.style.display="none"; }
function resolveResult(){
  const p=handTotal(playerHand);
  const d=handTotal(dealerHand);
  if(p>21) return "LOSE";
  if(d>21) return "WIN";
  if(p>d) return "WIN";
  if(p<d) return "LOSE";
  return "DRAW";
}
function endGame(result){
  gameOver=true;
  revealHole=true;
  renderHands();
  setButtons();
  const p=handTotal(playerHand);
  const d=handTotal(dealerHand);

  if(result==="WIN"){
    const special=(p===21);
    setStatus("WIN", "win");
    setHint(`あなた：<b>${p}</b> / ディーラー：<b>${d}</b>`);
    playSfx(special ? "blackjack" : "win");
    openReward(special);
  } else if(result==="LOSE"){
    setStatus("LOSE", "lose");
    setHint(`あなた：<b>${p}</b> / ディーラー：<b>${d}</b>`);
    playSfx("lose");
    impact("heavy");
  } else {
    setStatus("DRAW", "draw");
    setHint(`あなた：<b>${p}</b> / ディーラー：<b>${d}</b>`);
  }
}

function startHand(){
  if(deck.length<15) deck=newDeck();
  resetHand();
  gameOver=false;
  closeReward();
  revealHole=false;

  // いったん表示を空にして「配る」演出
  elDealerCards.innerHTML="";
  elPlayerCards.innerHTML="";
  elDealerTotal.textContent = "?";
  elPlayerTotal.textContent = "0";

  setStatus("DEALING…");
  setHint("カードを配っています");
  hitBtn.disabled = true;
  standBtn.disabled = true;

  playSfx("deal");
  impact("light");

  const steps = [
    {who:"player"},
    {who:"dealer"},
    {who:"player"},
    {who:"dealer"},
  ];

  function append(who, card, hide=false){
    const img=document.createElement("img");
    img.className="cardImg deal";
    img.style.animationDelay = "0ms";
    img.alt="card";
    img.src = hide ? CARD_BACK : cardImgPath(card);

    if(who==="dealer"){
      elDealerCards.appendChild(img);
    }else{
      elPlayerCards.appendChild(img);
    }
  }

  let i=0;
  const tick=()=>{
    if(i>=steps.length){
      // 配り終わり
      setStatus("PLAYING");
      setHint("HITで引く / STANDで勝負");
      hitBtn.disabled = false;
      standBtn.disabled = false;
      elShoePill.textContent = `山札：${deck.length}枚`;
      return;
    }
    const who = steps[i].who;

    const c = draw();
    if(who==="player"){
      playerHand.push(c);
      append("player", c, false);
    }else{
      dealerHand.push(c);
      // ディーラー2枚目は伏せる
      append("dealer", c, (dealerHand.length===2));
    }

    // 合計更新（ディーラーは伏せてる間は ? ）
    elPlayerTotal.textContent = String(handTotal(playerHand));
    elDealerTotal.textContent = revealHole ? String(handTotal(dealerHand)) : "?";
    elShoePill.textContent = `山札：${deck.length}枚`;

    impact("light");
    i++;
    setTimeout(tick, 180);
  };

  setTimeout(tick, 160);
}

dealBtn.addEventListener("click", ()=>{ if(!gameOver) return; startHand(); });
hitBtn.addEventListener("click", ()=>{
  if(gameOver) return;
  playSfx("hit");
  playerHand.push(draw());
  const p=handTotal(playerHand);
  renderHands();
  if(p>21) endGame("LOSE");
  else { setStatus("PLAYING"); setHint("もう一枚引きますか？ それともSTAND？"); }
});
standBtn.addEventListener("click", ()=>{
  if(gameOver) return;
  playSfx("stand");
  impact("light");
  revealHole=true;
  renderHands();
  while(true){
    const d=handTotal(dealerHand);
    if(d>21) break;
    if(!dealerShouldHit(d)) break;
    dealerHand.push(draw());
  }
  endGame(resolveResult());
});
restartBtn.addEventListener("click", ()=>{
  gameOver=true;
  resetHand();
  closeReward();
  setStatus("WELCOME");
  setHint("まずは <b>DEAL</b> を押して開始してください。");
  setButtons();
  renderHands();
});
closeRewardBtn.addEventListener("click", closeReward);
nextHandBtn.addEventListener("click", ()=>{ closeReward(); startHand(); });

deck=newDeck();
renderHands();
setButtons();
</script>
</body>
</html>
